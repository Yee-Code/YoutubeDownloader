name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: win-x64
            os: windows-latest
          - target: osx-x64
            os: macos-latest
          - target: osx-arm64
            os: macos-latest
          - target: linux-x64
            os: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 10.0.x

    - name: Make scripts executable (Linux)
      if: runner.os == 'Linux'
      run: |
        chmod +x build/*.sh

    # --- Windows Build ---
    - name: Build (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        .\build\build_win.cmd ${{ matrix.target }}

    - name: Zip Artifacts (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path "release/${{ matrix.target }}/*" -DestinationPath "YoutubeDownloader-${{ matrix.target }}.zip"

    # --- Linux Build ---
    - name: Build (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        ./build/build_linux.sh ${{ matrix.target }}

    - name: Zip Artifacts (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd release/${{ matrix.target }}
        zip -r ../../YoutubeDownloader-${{ matrix.target }}.zip .

    # --- macOS Build ---
    - name: Install Dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install ffmpeg
        chmod +x build/build_mac.sh

    - name: Build (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        ./build/build_mac.sh ${{ matrix.target }}

    - name: Zip Artifacts (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cd release/${{ matrix.target }}
        zip -r ../../YoutubeDownloader-${{ matrix.target }}.zip YoutubeDownloader.app

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: YoutubeDownloader-${{ matrix.target }}.zip
